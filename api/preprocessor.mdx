---
title: "PreProcessor"
description: "Filter and route messages before they reach your AI agent"
---

## Overview

`PreProcessor` allows you to intercept and process user messages before they reach your AI agent. Use preprocessors to filter spam, route messages, validate inputs, or modify messages before the agent sees them.

```typescript
import { PreProcessor } from 'lua-cli';

const profanityFilter = new PreProcessor({
  name: 'profanity-filter',
  description: 'Filter inappropriate content',
  priority: 10,
  execute: async (user, messages, channel) => {
    const hasProfanity = messages.some(msg => 
      msg.type === 'text' && msg.text.includes('badword')
    );
    
    if (hasProfanity) {
      // Block message and respond
      return {
        action: 'block',
        response: "Please keep the conversation respectful."
      };
    }
    
    // Allow messages to proceed
    return { action: 'proceed' };
  }
});

export default profanityFilter;
```

<Note>
**New in v3.0.0:** Message preprocessing for filtering, routing, and validation. Use with LuaAgent.
</Note>

## Use Cases

<CardGroup cols={2}>
  <Card title="Content Filtering" icon="filter">
    Block spam, profanity, or inappropriate content
  </Card>
  <Card title="Message Routing" icon="route">
    Route messages to different agents or handlers
  </Card>
  <Card title="Input Validation" icon="check">
    Validate message format or required information
  </Card>
  <Card title="Analytics" icon="chart-line">
    Track message metrics before processing
  </Card>
</CardGroup>

## Constructor

### new PreProcessor(config)

Creates a new message preprocessor.

<ParamField path="config" type="PreProcessorConfig" required>
  Preprocessor configuration object
</ParamField>

## Configuration Parameters

### Required Fields

<ParamField path="name" type="string" required>
  Unique preprocessor name
  
  **Examples**: `'profanity-filter'`, `'message-router'`
</ParamField>

<ParamField path="execute" type="function" required>
  Function that processes incoming messages
  
  **Signature:** `(user: UserDataInstance, messages: ChatMessage[], channel: string) => Promise<PreProcessorBlockResponse | PreProcessorProceedResponse>`
  
  **Arguments:**
  - `user`: The [UserDataInstance](#userdata-object) representing the current user.
  - `messages`: Array of [ChatMessage](#message-structure) objects sent by the user.
  - `channel`: The channel identifier (e.g., `'whatsapp'`, `'web'`, `'api'`).
</ParamField>

### Optional Fields

<ParamField path="version" type="string">
  Preprocessor version. Defaults to `'1.0.0'`.
</ParamField>

<ParamField path="description" type="string">
  Preprocessor description for documentation
</ParamField>

<ParamField path="priority" type="number">
  Execution priority (lower runs first). Default: `100`
</ParamField>

<ParamField path="async" type="boolean">
  Whether to run asynchronously (non-blocking). Default: `false`
</ParamField>

## UserData Object

The `user` argument passed to `execute` provides access to the current user's data and methods.

```typescript
interface UserDataInstance {
  // Direct access to user data properties
  uid: string;
  name?: string;
  email?: string;
  [key: string]: any;

  // Helper methods
  getChatHistory(): Promise<ChatHistoryMessage[]>;
  // ... other user management methods
}
```

## Message Structure

The `messages` array passed to your execute function contains `ChatMessage` objects:

```typescript
type ChatMessage = TextMessage | ImageMessage | FileMessage;

interface TextMessage {
  type: 'text';
  text: string;
}

interface ImageMessage {
  type: 'image';
  image: string; // URL or base64
}

interface FileMessage {
  type: 'file';
  file: string; // URL
}
```

## Return Type

Your execute function must return a `PreProcessorBlockResponse` or `PreProcessorProceedResponse` object indicating whether to proceed or block.

### 1. Proceed

To allow the message to continue to the next preprocessor or the agent:

```typescript
// Proceed with original message
return { action: 'proceed' };

// OR proceed with a modified message
return { 
  action: 'proceed',
  modifiedMessage: [{ type: 'text', text: 'Modified content' }]
};
```

### 2. Block

To stop processing immediately and respond to the user:

```typescript
return {
  action: 'block',
  response: "This message was blocked."
};
```

## Complete Examples

### Profanity Filter

```typescript
import { PreProcessor } from 'lua-cli';

const profanityWords = ['badword1', 'badword2', 'badword3'];

const profanityFilter = new PreProcessor({
  name: 'profanity-filter',
  description: 'Block messages containing inappropriate language',
  priority: 10, // Run early
  
  execute: async (user, messages, channel) => {
    // Check all text messages
    const hasProfanity = messages.some(msg => {
      if (msg.type === 'text') {
        return profanityWords.some(word => msg.text.toLowerCase().includes(word));
      }
      return false;
    });
    
    if (hasProfanity) {
      console.log(`Blocked profanity from user ${user.uid}`);
      return {
        action: 'block',
        response: "Please keep the conversation respectful. Inappropriate language is not allowed."
      };
    }
    
    return { action: 'proceed' };
  }
});

export default profanityFilter;
```

### Business Hours Filter

```typescript
import { PreProcessor } from 'lua-cli';

const businessHoursFilter = new PreProcessor({
  name: 'business-hours-filter',
  description: 'Block messages outside business hours',
  
  execute: async (user, messages, channel) => {
    const now = new Date();
    const hour = now.getHours();
    const day = now.getDay();
    
    // Business hours: Mon-Fri, 9 AM - 5 PM
    const isWeekday = day >= 1 && day <= 5;
    const isBusinessHours = hour >= 9 && hour < 17;
    
    if (!isWeekday || !isBusinessHours) {
      return {
        action: 'block',
        response: "Thank you for contacting us. Our business hours are Monday-Friday, 9 AM - 5 PM. We'll respond to your message during our next business day."
      };
    }
    
    return { action: 'proceed' };
  }
});

export default businessHoursFilter;
```

### Message Enrichment

```typescript
import { PreProcessor } from 'lua-cli';

const messageEnricher = new PreProcessor({
  name: 'message-enricher',
  description: 'Add context to messages before processing',
  priority: 50,
  
  execute: async (user, messages, channel) => {
    // Enrich message with user info
    const enrichedMessages = messages.map(msg => {
      if (msg.type === 'text') {
        return {
          ...msg,
          text: `${msg.text}\n\n[Context: User ID ${user.uid}]`
        };
      }
      return msg;
    });
    
    return {
      action: 'proceed',
      modifiedMessage: enrichedMessages
    };
  }
});

export default messageEnricher;
```

## Execution Flow

Preprocessors are executed in a **pipeline**:

1.  **Sequential Execution**: Preprocessors run one after another, sorted by `priority`.
2.  **Modifications**: If a preprocessor modifies a message, the *next* preprocessor receives the modified version.
3.  **Blocking**: If any preprocessor returns `action: 'block'`, execution stops immediately, and the response is sent to the user. The agent is not called.

## Testing Preprocessors

```bash
lua test
# Select: PreProcessor â†’ your-preprocessor-name
# Provide test message
```

## See Also

- [PostProcessor](/api/postprocessor) - Processing responses
- [LuaAgent](/api/luaagent) - Adding preprocessors to your agent
