---
title: "User API"
description: "Access and manage user profile data"
---

## Overview

The User API provides access to the current user's profile information through a powerful `UserDataInstance` class with direct property access.

```typescript
import { User } from 'lua-cli';

// Get user instance
const user = await User.get();

// Access the new read-only user profile
console.log(user._luaProfile.fullName);
console.log(user._luaProfile.emailAddresses); // A simple array of strings

// Continue to use the user object for your agent's custom data
user.lastProductViewed = 'SKU-123';
await user.save();
```

## Read-Only User Profile (`_luaProfile`)

A new, read-only property `user._luaProfile` is now available on the user object. This provides a secure and reliable way to access core user identity information.

- **`_luaProfile`** (Read-Only): Contains essential user data like `userId`, `fullName`, `mobileNumbers`, and `emailAddresses`.
  - The `_lua` prefix indicates this is a special, system-provided property.
  - This data is **immutable**; any attempts to change it will be silently ignored.
- **`user.*`** (Mutable): Continue to use the main `user` object to store and manage any custom data your agent needs, such as preferences, shopping carts, or game scores.

<CardGroup>
  <Card title="Core User Identity" icon="lock">
    Access read-only data like `user._luaProfile.userId` and `user._luaProfile.fullName`.
  </Card>
  <Card title="Custom Agent Data" icon="pencil">
    Read and write your agent's data directly, like `user.cart` or `user.preferences`.
  </Card>
</CardGroup>

### Deprecated `user.userId`
To centralize core user information, `user.userId` is now deprecated. Please update your code to use `user._luaProfile.userId`. The old property will be removed in a future version.

```typescript
// ‚úÖ New & Recommended
const userId = user._luaProfile.userId;

// ‚ö†Ô∏è Deprecated
const oldUserId = user.userId;
```

## Features

<CardGroup cols={2}>
  <Card title="Direct Access" icon="bolt">
    Access properties with `user.name` instead of `user.data.name`
  </Card>
  <Card title="Auto Sanitization" icon="shield">
    Removes sensitive fields automatically
  </Card>
  <Card title="Built-in Methods" icon="wrench">
    `update()`, `save()`, `send()`, and `clear()` included
  </Card>
  <Card title="Messaging" icon="message">
    Send text, images, and files to users
  </Card>
</CardGroup>

## get(identifier?)

Retrieve user data as a UserDataInstance. Supports lookup by userId, email, or phone number.

```typescript
User.get(identifier?: string | UserLookupOptions): Promise<UserDataInstance | null>
```

<ParamField path="identifier" type="string | UserLookupOptions">
  One of:
  - **No parameter**: Returns current user from conversation context
  - **string (userId)**: Retrieve a specific user by ID
  - **{ email: string }**: Look up user by email address
  - **{ phone: string }**: Look up user by phone number (with or without `+` prefix)
  
  **Required in:** Webhooks, pre-defined LuaJob (no conversational context)
  
  **Optional in:** Tools, dynamic jobs (has conversational context)
</ParamField>

**Returns:** `UserDataInstance` with proxy-based property access, or `null` if user not found (for email/phone lookup)

<Note>
**New in Latest Version:** Look up users by email or phone! This is especially useful in webhooks where you receive contact info from external systems but don't have the internal userId.
</Note>

## When to Use userId Parameter

Understanding when userId is required vs optional:

| Context | Method | Identifier Required? | Why |
|---------|--------|------------------|-----|
| **Tools** | `User.get()` | ‚ùå Optional | Has conversational context |
| **Webhooks** | `User.get(userId)` or `User.get({ email })` | ‚úÖ **REQUIRED** | No conversational context |
| **LuaJob** | `User.get(userId)` or `User.get({ phone })` | ‚úÖ **REQUIRED** | No conversational context |
| **Jobs API** | `jobInstance.user()` | ‚ùå N/A | Automatic user context |

<Warning>
**Context Matters:**
- **Tools:** identifier is optional - defaults to current user in conversation
- **Webhooks:** identifier is REQUIRED - use userId, email, or phone lookup
- **LuaJob (pre-defined):** identifier is REQUIRED - use userId, email, or phone lookup
- **Jobs API (dynamic):** Use `jobInstance.user()` instead - automatic context captured!
</Warning>

<Tip>
**New!** In webhooks, you can now look up users by email or phone if you don't have the userId:
```typescript
const user = await User.get({ email: 'customer@example.com' });
const user = await User.get({ phone: '+1234567890' });
```
</Tip>

**Examples:**

<Tabs>
  <Tab title="Current User">
    **Get the current user from conversation context:**
    
    ```typescript
    import { User } from 'lua-cli';
    
    // In your tool
    async execute(input: any) {
      const user = await User.get();
      
      // Direct property access
      console.log(user.name);    // "John Doe"
      console.log(user.email);   // "john@example.com"
      console.log(user.phone);   // "555-0123"
      
      return { userName: user.name };
    }
    ```
  </Tab>

  <Tab title="Specific User (Webhooks/LuaJob)">
    **Get a specific user by ID (REQUIRED in webhooks and pre-defined jobs):**
    
    ```typescript
    import { User } from 'lua-cli';
    
    // In a webhook (NO conversational context)
    execute: async (event) => {
      // ‚ö†Ô∏è MUST provide userId in webhooks
      const customerId = event.data.object.metadata?.customerId;
      
      if (!customerId) {
        return { error: 'No customer ID provided' };
      }
      
      const user = await User.get(customerId);
      
      // Send message to that specific user
      await user.send([{
        type: 'text',
        text: `‚úÖ Payment received: $${event.data.object.amount/100}`
      }]);
      
      return { notified: true };
    }
    ```
    
    **Required in:**
    - ‚úÖ **Webhooks** - No conversational context
    - ‚úÖ **LuaJob (pre-defined)** - No conversational context
    - ‚úÖ **Admin tools** - Managing other users
    
    **NOT needed in:**
    - ‚ùå **Tools** - Use `User.get()` without userId
    - ‚ùå **Jobs API (dynamic)** - Use `jobInstance.user()` instead
  </Tab>
  
  <Tab title="Dynamic Jobs (Special Case)">
    **Dynamic jobs have automatic user context:**
    
    ```typescript
    import { Jobs } from 'lua-cli';
    
    // Creating a dynamic job from a tool
    await Jobs.create({
      name: 'user-reminder',
      execute: async (jobInstance) => {
        // ‚úÖ Use jobInstance.user() - automatic context!
        const user = await jobInstance.user();
        
        await user.send([{
          type: 'text',
          text: 'Reminder: Your meeting starts in 5 minutes!'
        }]);
      }
    });
    ```
    
    **Why it works:** Dynamic jobs created from tools automatically capture the user context, so you don't need to provide a userId.
  </Tab>
  
  <Tab title="Email/Phone Lookup">
    **Look up a user by email or phone number:**
    
    ```typescript
    import { User } from 'lua-cli';
    
    // In a webhook receiving customer contact info
    execute: async (event) => {
      const { email, phone } = event.body;
      
      // Look up by email
      const userByEmail = await User.get({ email: 'customer@example.com' });
      
      // Look up by phone (both formats work)
      const userByPhone = await User.get({ phone: '+1234567890' });
      const userByPhone2 = await User.get({ phone: '1234567890' });
      
      // Handle not found gracefully
      if (!userByEmail) {
        return { error: 'User not found' };
      }
      
      // Update the user's data
      userByEmail.routingEnabled = true;
      await userByEmail.save();
      
      return { 
        success: true, 
        userId: userByEmail._luaProfile.userId 
      };
    }
    ```
    
    **Use cases:**
    - ‚úÖ **Webhooks** - External systems send email/phone, not userId
    - ‚úÖ **Admin tools** - Operators search by contact info
    - ‚úÖ **Integrations** - Third-party systems don't have Lua user IDs
    
    <Warning>
    **Returns `null` if not found:** Unlike `User.get(userId)` which throws on not found, email/phone lookup returns `null`. Always check for null before using the user object.
    </Warning>
  </Tab>
</Tabs>

## UserDataInstance API

### Property Access (Direct)

Access any user property directly:

```typescript
// Reading properties
const name = user.name;
const email = user.email;
const preferences = user.preferences;
const customField = user.customField;

// Setting properties (local only - call update() to persist)
user.name = "Jane Doe";
user.email = "jane@example.com";
user.preferences = { theme: "dark" };

// Checking existence
if ('name' in user) {
  console.log('User has a name');
}
```

### update()

Update user data on the server and locally.

```typescript
user.update(data: Record<string, any>): Promise<any>
```

<ParamField path="data" type="object" required>
  Object containing fields to update or add
</ParamField>

**Returns:** Promise resolving to updated sanitized user data

**Examples:**

```typescript
// Update single field
await user.update({ name: "John Doe" });

// Update multiple fields
await user.update({
  name: "John Doe",
  email: "john@example.com",
  phone: "555-1234"
});

// Update nested objects
await user.update({
  preferences: {
    theme: "dark",
    notifications: true,
    language: "en"
  }
});

// Access updated data immediately
console.log(user.name);  // "John Doe"
console.log(user.preferences.theme);  // "dark"
```

### save()

Save the current state of user data to the server. This is a convenience method that persists all changes made to the user instance.

```typescript
user.save(): Promise<boolean>
```

**Returns:** Promise resolving to `true` if successful

**Examples:**

```typescript
const user = await User.get();

// Modify properties
user.name = "John Doe";
user.email = "john@example.com";
user.phone = "555-1234";

// Save all changes at once
await user.save();

// Much cleaner than multiple update calls!
```

<Note>
**New in Latest Version:** The `save()` method provides a simpler workflow - modify properties then save, rather than passing data to `update()`.
</Note>

### send()

Send messages to the user conversation. Supports text, images, and file attachments.

```typescript
user.send(messages: Message[]): Promise<any>
```

<ParamField path="messages" type="Message[]" required>
  Array of messages to send (text, image, or file)
</ParamField>

**Message Types:**

```typescript
// Text message
type TextMessage = {
  type: "text";
  text: string;
};

// Image message
type ImageMessage = {
  type: "image";
  image: string;      // Base64 encoded image data
  mediaType: string;   // e.g., "image/png", "image/jpeg"
};

// File message
type FileMessage = {
  type: "file";
  data: string;       // Base64 encoded file data
  mediaType: string;   // e.g., "application/pdf"
};
```

**Examples:**

```typescript
const user = await User.get();

// Send a text message
await user.send([
  { type: "text", text: "Your order has been shipped!" }
]);

// Send multiple messages
await user.send([
  { type: "text", text: "Here is your receipt:" },
  { 
    type: "image", 
    image: base64ImageData, 
    mediaType: "image/png" 
  }
]);

// Send a file
await user.send([
  { type: "text", text: "Your invoice is attached:" },
  {
    type: "file",
    data: base64PdfData,
    mediaType: "application/pdf"
  }
]);
```

<Note>
**New in Latest Version:** Send proactive messages to users for notifications, updates, and automated workflows.
</Note>

### clear()

Clear all user data for the current user.

```typescript
user.clear(): Promise<boolean>
```

**Returns:** Promise resolving to `true` if successful

**Example:**

```typescript
try {
  const success = await user.clear();
  if (success) {
    console.log('User data cleared successfully');
  }
} catch (error) {
  console.error('Failed to clear user data:', error);
}
```

<Warning>
**Destructive operation!** This removes all user data. Use with caution.
</Warning>

## Data Sanitization

UserDataInstance automatically removes sensitive fields:

**Removed (not accessible):**
- `agentId`
- `userId`

**Available (accessible):**
- `name`, `email`, `phone`
- Custom fields you set
- Preferences and settings
- Any other data

```typescript
// Server returns:
{
  userId: "12345",       // ‚ùå Removed
  agentId: "agent-123",  // ‚ùå Removed
  name: "John Doe",      // ‚úÖ Accessible
  email: "john@example.com"  // ‚úÖ Accessible
}

// Your user instance has:
{
  name: "John Doe",
  email: "john@example.com"
}
```

## Complete Examples

### Example 1: User Preferences

```typescript
import { LuaTool } from 'lua-cli';
import { z } from 'zod';

export class ManagePreferencesTool implements LuaTool {
  name = "manage_preferences";
  description = "Manage user preferences";
  
  inputSchema = z.object({
    theme: z.enum(['light', 'dark']).optional(),
    notifications: z.boolean().optional(),
    language: z.string().optional()
  });

  async execute(input: any, context: ToolContext) {
    const user = context.user;
    
    // Direct property access
    const currentPrefs = user.preferences || {};
    
    // Merge with new preferences
    const newPrefs = {
      ...currentPrefs,
      ...input
    };
    
    // Update on server
    await user.update({ preferences: newPrefs });
    
    return {
      message: 'Preferences updated successfully',
      preferences: user.preferences  // Direct access to updated data
    };
  }
}
```

### Example 2: Shopping Cart Persistence

```typescript
export class CartTool implements LuaTool {
  name = "manage_cart";
  description = "Manage shopping cart";
  
  inputSchema = z.object({
    action: z.enum(['add', 'remove', 'get']),
    productId: z.string().optional(),
    quantity: z.number().optional()
  });

  async execute(input: any, context: ToolContext) {
    const user = context.user;
    
    // Get current cart (direct access)
    let cart = user.cart || [];
    
    if (input.action === 'add') {
      cart.push({
        productId: input.productId,
        quantity: input.quantity
      });
      await user.update({ cart });
    }
    
    if (input.action === 'remove') {
      cart = cart.filter(item => item.productId !== input.productId);
      await user.update({ cart });
    }
    
    return {
      cart: user.cart,  // Direct access
      itemCount: cart.length
    };
  }
}
```

### Example 3: User Profile Management

```typescript
export class ProfileTool implements LuaTool {
  name = "update_profile";
  description = "Update user profile information";
  
  inputSchema = z.object({
    firstName: z.string().optional(),
    lastName: z.string().optional(),
    phone: z.string().optional(),
    bio: z.string().optional()
  });

  async execute(input: any, context: ToolContext) {
    const user = context.user;
    
    // Update user data
    await user.update(input);
    
    // Return updated profile (direct access)
    return {
      success: true,
      profile: {
        firstName: user.firstName,
        lastName: user.lastName,
        phone: user.phone,
        bio: user.bio
      },
      message: 'Profile updated successfully'
    };
  }
}
```

### Example 4: Personalized Greeting

```typescript
export class GreetUserTool implements LuaTool {
  name = "greet_user";
  description = "Greet user with personalized message";
  
  inputSchema = z.object({});

  async execute(input: any, context: ToolContext) {
    const user = context.user;
    
    // Direct property access
    const hour = new Date().getHours();
    const timeGreeting = hour < 12 ? 'Good morning'
      : hour < 18 ? 'Good afternoon'
      : 'Good evening';
    
    return {
      message: `${timeGreeting}, ${user.name}! How can I help you today?`
    };
  }
}
```

### Example 5: Order Notification with Messaging

```typescript
export class SendOrderNotificationTool implements LuaTool {
  name = "send_order_notification";
  description = "Send order status notification to user";
  
  inputSchema = z.object({
    orderId: z.string(),
    status: z.enum(['shipped', 'delivered']),
    trackingNumber: z.string().optional(),
    receiptUrl: z.string().optional()
  });

  async execute(input: z.infer<typeof this.inputSchema>, context: ToolContext) {
    const user = context.user;
    
    // Build notification message
    const messages = [
      {
        type: "text" as const,
        text: `Hi ${user.name}! Your order #${input.orderId} has been ${input.status}.`
      }
    ];
    
    // Add tracking info if shipped
    if (input.status === 'shipped' && input.trackingNumber) {
      messages.push({
        type: "text" as const,
        text: `Tracking number: ${input.trackingNumber}`
      });
    }
    
    // Send messages to user
    await user.send(messages);
    
    // Update user's notification preferences
    user.lastNotificationSent = new Date().toISOString();
    await user.save();
    
    return {
      success: true,
      message: "Notification sent successfully"
    };
  }
}
```

### Example 6: Send Receipt with Image

```typescript
export class SendReceiptTool implements LuaTool {
  name = "send_receipt";
  description = "Send order receipt with QR code";
  
  inputSchema = z.object({
    orderId: z.string(),
    amount: z.number(),
    qrCodeBase64: z.string()
  });

  async execute(input: z.infer<typeof this.inputSchema>, context: ToolContext) {
    const user = context.user;
    
    // Send receipt with QR code
    await user.send([
      {
        type: "text",
        text: `Thank you for your order! Total: $${input.amount.toFixed(2)}`
      },
      {
        type: "text",
        text: "Here's your receipt QR code for easy access:"
      },
      {
        type: "image",
        image: input.qrCodeBase64,
        mediaType: "image/png"
      }
    ]);
    
    return {
      success: true,
      message: "Receipt sent to user"
    };
  }
}
```

## Best Practices

<AccordionGroup>
  <Accordion title="‚úÖ Use Direct Property Access">
    ```typescript
    // ‚úÖ Recommended
    const name = user.name;
    const email = user.email;
    
    // üü° Still works but verbose
    const name = user.data.name;
    const email = user.data.email;
    ```
  </Accordion>

  <Accordion title="‚úÖ Batch Updates">
    Combine multiple updates into one call:
    
    ```typescript
    // ‚úÖ Good - Single update call
    await user.update({
      name: "John Doe",
      email: "john@example.com",
      phone: "555-1234"
    });
    
    // ‚ùå Bad - Multiple update calls
    await user.update({ name: "John Doe" });
    await user.update({ email: "john@example.com" });
    await user.update({ phone: "555-1234" });
    ```
  </Accordion>

  <Accordion title="‚úÖ Handle Missing Fields">
    Not all fields may be present:
    
    ```typescript
    const phone = user.phone || 'Not provided';
    const name = user.name || 'Guest';
    const preferences = user.preferences || {};
    ```
  </Accordion>

  <Accordion title="‚úÖ Use for Personalization">
    ```typescript
    // Personalized responses
    return {
      message: `Welcome back, ${user.name}!`,
      savedItems: user.cart?.length || 0,
      lastVisit: user.lastSeen
    };
    ```
  </Accordion>

  <Accordion title="‚úÖ Use save() for Multiple Changes">
    The new `save()` method is perfect for multiple changes:
    
    ```typescript
    // ‚úÖ Recommended - Modify then save
    user.name = "John Doe";
    user.email = "john@example.com";
    user.preferences = { theme: "dark" };
    await user.save();
    
    // üü° Still works - Update method
    await user.update({
      name: "John Doe",
      email: "john@example.com",
      preferences: { theme: "dark" }
    });
    ```
  </Accordion>

  <Accordion title="‚úÖ Use send() for Proactive Notifications">
    Send messages to users for order updates, alerts, and more:
    
    ```typescript
    // Send order shipped notification
    await user.send([
      { type: "text", text: "Your order has been shipped!" },
      { type: "text", text: "Tracking: TRACK123456" }
    ]);
    
    // Send with image
    await user.send([
      { type: "text", text: "Your boarding pass:" },
      { type: "image", image: qrCodeBase64, mediaType: "image/png" }
    ]);
    ```
  </Accordion>

  <Accordion title="‚ö†Ô∏è Message Format Requirements">
    Ensure correct message format:
    
    ```typescript
    // ‚úÖ Correct
    await user.send([
      { type: "text", text: "Hello!" }
    ]);
    
    // ‚úÖ Multiple messages
    await user.send([
      { type: "text", text: "Message 1" },
      { type: "text", text: "Message 2" }
    ]);
    
    // ‚ùå Wrong - Must be array
    await user.send({ type: "text", text: "Hello!" });
    ```
  </Accordion>
</AccordionGroup>

## TypeScript Support

```typescript
// User lookup options for email/phone lookup
interface UserLookupOptions {
  /** Email address to look up */
  email?: string;
  /** Phone number to look up (with or without + prefix) */
  phone?: string;
}

interface UserDataInstance {
  // Properties (dynamic based on stored data)
  name?: string;
  email?: string;
  phone?: string;
  [key: string]: any;
  
  // Methods
  update(data: Record<string, any>): Promise<any>;
  save(): Promise<boolean>;
  send(messages: Message[]): Promise<any>;
  clear(): Promise<boolean>;
  toJSON(): Record<string, any>;
}

// Message types
type TextMessage = {
  type: "text";
  text: string;
};

type ImageMessage = {
  type: "image";
  image: string;
  mediaType: string;
};

type FileMessage = {
  type: "file";
  data: string;
  mediaType: string;
};

type Message = TextMessage | ImageMessage | FileMessage;
```

### Usage with Types

```typescript
// Define your user data shape
interface MyUserData {
  name: string;
  email: string;
  preferences: {
    theme: 'light' | 'dark';
    notifications: boolean;
  };
}

// Access with type safety
const user = context.user;
const name: string = user.name;
const theme = user.preferences?.theme || 'light';
```

## Next Steps

<CardGroup cols={2}>
  <Card
    title="Data API"
    icon="database"
    href="/api/data"
  >
    Store custom user data
  </Card>
  <Card
    title="User Data Examples"
    icon="layer-group"
    href="/examples/user-data"
  >
    See working examples
  </Card>
</CardGroup>

