---
title: "Webhooks"
description: "HTTP endpoints for receiving external events"
---

## What are Webhooks?

**Webhooks** are HTTP endpoints that allow external services to send events to your agent. When something happens in an external system (like a payment completing or an order shipping), that system can notify your agent in real-time.

<Card title="Think of it as:" icon="webhook">
  A phone number for your agent - external services can "call" it when events happen
</Card>

<Warning>
**No Conversational Context:** Webhooks execute outside of user conversations. You MUST provide a userId when calling `User.get(userId)` to notify specific users. Store user IDs in your payment/order metadata.
</Warning>

<Note>
**New in v3.0.0:** Built-in webhook support for seamless external integrations.
</Note>

## Why Webhooks?

<CardGroup cols={2}>
  <Card title="Real-Time Events" icon="bolt">
    Get notified instantly when events happen in external systems
  </Card>
  <Card title="Automated Actions" icon="gears">
    Automatically respond to external events without user interaction
  </Card>
  <Card title="Seamless Integration" icon="plug">
    Connect with Stripe, Shopify, GitHub, and any webhook-enabled service
  </Card>
  <Card title="Event-Driven" icon="satellite-dish">
    Build reactive agents that respond to real-world events
  </Card>
</CardGroup>

## How Webhooks Work

<Steps>
  <Step title="External Event Occurs">
    Something happens: payment completes, order ships, PR merges, etc.
  </Step>
  
  <Step title="Service Sends HTTP Request">
    The external service (Stripe, Shopify) sends a POST request to your webhook URL
  </Step>
  
  <Step title="Your Webhook Receives Event">
    Your LuaWebhook's execute function is called with the event data
  </Step>
  
  <Step title="Your Code Takes Action">
    Process the event: update orders, notify users, trigger jobs, etc.
  </Step>
  
  <Step title="Return Response">
    Return acknowledgment to the external service
  </Step>
</Steps>

## Simple Example

```typescript
import { LuaWebhook, User } from 'lua-cli';

const paymentWebhook = new LuaWebhook({
  name: 'payment-webhook',
  description: 'Handle Stripe payment events',
  
  execute: async (event) => {
    if (event.type === 'payment_intent.succeeded') {
      // ⚠️ Webhooks have NO conversational context
      // You MUST provide userId to User.get()
      
      // Get user ID from payment metadata
      const customerId = event.data.object.metadata?.customerId;
      
      if (!customerId) {
        console.error('No customerId in payment metadata');
        return { received: true, error: 'No customer ID' };
      }
      
      // Retrieve specific user by ID
      const user = await User.get(customerId);
      
      // Send payment confirmation to that user
      await user.send([{
        type: 'text',
        text: `✅ Payment confirmed! Amount: ${event.data.object.amount} ${event.data.object.currency.toUpperCase()}`
      }]);
    }
    
    return { received: true };
  }
});
```

<Warning>
**Critical:** Webhooks execute outside conversational context. `User.get()` REQUIRES a userId parameter. Always store the user ID in your payment/order metadata when creating transactions.
</Warning>

## Common Use Cases

<Tabs>
  <Tab title="Payments">
    **Stripe, PayPal, Square**
    
    Handle payment events:
    - Payment succeeded
    - Payment failed
    - Refund processed
    - Subscription updated
    
    Actions:
    - Update order status
    - Notify customer
    - Trigger fulfillment
  </Tab>

  <Tab title="E-commerce">
    **Shopify, WooCommerce**
    
    Handle order events:
    - Order created
    - Order fulfilled
    - Order cancelled
    - Inventory updated
    
    Actions:
    - Sync order data
    - Update inventory
    - Send confirmations
  </Tab>

  <Tab title="Development">
    **GitHub, GitLab**
    
    Handle code events:
    - Push to repository
    - Pull request opened
    - Deployment completed
    - Release published
    
    Actions:
    - Notify team
    - Trigger workflows
    - Update dashboards
  </Tab>

  <Tab title="Custom">
    **Your Internal Systems**
    
    Any event from your backend:
    - User signup
    - Task completed
    - Threshold exceeded
    - Data changed
    
    Actions:
    - Whatever you need!
  </Tab>
</Tabs>

## Adding Webhooks to Your Agent

Webhooks are added to your LuaAgent configuration:

```typescript
import { LuaAgent } from 'lua-cli';
import paymentWebhook from './webhooks/payment';
import orderWebhook from './webhooks/order';

export const agent = new LuaAgent({
  name: "my-agent",
  persona: "...",
  skills: [...],
  
  // Add webhooks
  webhooks: [
    paymentWebhook,
    orderWebhook
  ]
});
```

## Webhook URLs

After deploying, your webhooks get URLs like:

```
https://api.heylua.ai/webhooks/{agent-id}/{webhook-name}
```

Configure this URL in your external service's webhook settings.

## Best Practices

<AccordionGroup>
  <Accordion title="✅ Store User IDs in Metadata">
    **Always include user ID in payment/order metadata**
    
    When creating payments or orders, store the Lua user ID:
    
    ```typescript
    // When creating Stripe payment
    const paymentIntent = await stripe.paymentIntents.create({
      amount: 2000,
      currency: 'usd',
      metadata: {
        customerId: user.id,  // ← Lua user ID
        orderId: order.id
      }
    });
    ```
    
    Then in your webhook, retrieve the specific user:
    
    ```typescript
    execute: async (event) => {
      const customerId = event.data.object.metadata.customerId;
      const user = await User.get(customerId);
      await user.send([{ type: 'text', text: 'Payment confirmed!' }]);
    }
    ```
  </Accordion>

  <Accordion title="✅ Verify Signatures">
    **Always verify webhook signatures to prevent unauthorized requests**
    
    ```typescript
    const secureWebhook = new LuaWebhook({
      name: 'secure-webhook',
      secret: env('WEBHOOK_SECRET'),
      verifySignature: true,  // ← Important!
      
      execute: async (event) => {
        // Only processes verified requests
      }
    });
    ```
  </Accordion>

  <Accordion title="✅ Handle Errors Gracefully">
    **Don't throw errors - return error status**
    
    ```typescript
    execute: async (event) => {
      try {
        // Process event
        return { success: true };
      } catch (error) {
        console.error('Webhook error:', error);
        return { success: false, error: error.message };
      }
    }
    ```
  </Accordion>

  <Accordion title="✅ Return Quickly">
    **Webhooks should respond within 5 seconds**
    
    For long-running work, queue a job:
    
    ```typescript
    execute: async (event) => {
      // Quick validation
      if (!isValid(event)) return { error: 'Invalid' };
      
      // Queue long-running work
      await Jobs.create({
        execute: async () => {
          // Process here
        }
      });
      
      return { received: true };
    }
    ```
  </Accordion>
</AccordionGroup>

## Next Steps

<CardGroup cols={2}>
  <Card
    title="Webhooks API Reference"
    icon="book"
    href="/api/luawebhook"
  >
    Complete API documentation with examples
  </Card>
  <Card
    title="Agent Concept"
    icon="robot"
    href="/overview/agent"
  >
    Learn about LuaAgent configuration
  </Card>
  <Card
    title="Jobs Concept"
    icon="clock"
    href="/overview/jobs"
  >
    Understand scheduled tasks
  </Card>
  <Card
    title="Skills Concept"
    icon="puzzle-piece"
    href="/overview/skill"
  >
    Learn about skills and tools
  </Card>
</CardGroup>

